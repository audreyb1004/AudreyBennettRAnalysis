---
title: "MSDS 401 Final Exam - Audrey Bennett"
output:
  html_document: default
  pdf_document: default
---


Raw Data Link: https://www.ecdc.europa.eu/en/publications-data/data-daily-new-cases-covid-19-eueea-country)

For the take-home part of the MSDS 401 Final Exam, you are tasked with analyzing data on new daily covid-19 cases and deaths in European Union (EU) and European Economic Area (EEA) countries. 

Goals:
(1) perform an Exploratory Data Analysis (EDA)
(2) perform hypothesis testing
(3) perform correlation testing
(4) fit and describe a linear regression model.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE,
                      message = FALSE)

library(ggplot2)
library(gridExtra)
library(lubridate)
library(tidyverse)
library(dplyr)
library(Hmisc)

# The read.csv() below reads the data directly from the web. You may use this or
# you can download and read from a local copy of the data file. To work from a
# local file, you will need to modify the read.csv() code here:

data <- read.csv("https://opendata.ecdc.europa.eu/covid19/nationalcasedeath_eueea_daily_ei/csv",
                 na.strings = "", fileEncoding = "UTF-8-BOM")

# The zero-th step in any analysis is to 'sanity check' our data. Here, we call
# glimpse() from the 'dplyr' package, but utils::str() would work, as well.
glimpse(data)

#

# The last thing we're going to do is drop the 'continentExp' vector (as all
# observations are "Europe"), coerce the 'dateRep' vector to a date format, and
# coerce the country and territory vectors to factors.

data <- data %>%
  select(-c("continentExp")) %>%
  mutate(dateRep = dmy(dateRep),
         countriesAndTerritories = as.factor(countriesAndTerritories),
         geoId = as.factor(geoId),
         countryterritoryCode = as.factor(countryterritoryCode))

```


#### (1) Exploratory Data Analysis (EDA)
  
```{r descriptive_stats, fig.width = 8, fig.height = 8}
## Exploratory Data Analysis

summary(data)

data$incidence_rate <- (data$cases/data$popData2020)*100000
data$fatality_rate <- (data$deaths/data$popData2020)*100000

plotdata1 <- filter(data, countriesAndTerritories == c("Austria", "Belgium", "Croatia", "Denmark", "Estonia"))
  
p1 <- ggplot(data=plotdata1,aes(x=as.character(dateRep),y=incidence_rate,group=countriesAndTerritories)) +
  geom_point(aes(color=countriesAndTerritories)) +
  ggtitle("COVID-19 Incidence Rates per 100,000 people per Country (Filtered by ABCDE Countries)") +
  theme(plot.title = element_text(hjust = .5)) +
  xlab("Time") + 
  ylab("Incidence Rate") +
  scale_fill_brewer(palette='Spectral')

p2 <- ggplot(data=plotdata1,aes(x=as.character(dateRep),y=fatality_rate,group=countriesAndTerritories)) +
  geom_point(aes(color=countriesAndTerritories)) +
  ggtitle("COVID-19 Fatality Rates per 100,000 people per Country (Filtered by ABCDE Countries)") +
  theme(plot.title = element_text(hjust = .5)) +
  xlab("Time") + 
  ylab("Fatality Rate") +
  scale_fill_brewer(palette='Spectral')

grid.arrange(p1, p2)
```

#### (2) Hypothesis Testing

```{r inferential_stats, fig.width = 9, fig.height = 8}
## Inferential Statistics

# Countries of Interest: Austria & Belgium

plotdata2 <- filter(data, countriesAndTerritories == c("Austria", "Belgium"))

p3 <- ggplot(data=plotdata2,aes(x=as.character(dateRep),y=fatality_rate,group=countriesAndTerritories)) +
  geom_line(aes(color=countriesAndTerritories)) +
  ggtitle("COVID-19 Incidence Rates per 100,000 people per Country (Filtered by ABCDE Countries)") +
  theme(plot.title = element_text(hjust = .5)) +
  xlab("Time") + 
  ylab("Incidence Rate") +
  scale_fill_brewer(palette='Spectral')


p4 <- ggplot(data=plotdata2,aes(x=as.character(dateRep),y=fatality_rate,group=countriesAndTerritories)) +
  geom_line(aes(color=countriesAndTerritories)) +
  ggtitle("COVID-19 Fataltiy Rates per 100,000 people per Country (Filtered by ABCDE Countries)") +
  theme(plot.title = element_text(hjust = .5)) +
  xlab("Time") + 
  ylab("Fatality Rate") +
  scale_fill_brewer(palette='Spectral')

grid.arrange(p3, p4)

# Hypothesis Testing, where:
# m1 = avg fatality rate in Austria 
# m2 = avg fatality rate in Belgium
# Null Hypothesis: m1 = m2
# Alternative Hypothesis: m1 != m2
# Thus, we are testing if the fatality rates (average) in Austria differ from Belgium

# Subset data
a_data <- subset(data, countriesAndTerritories == "Austria")
b_data <- subset(data, countriesAndTerritories == "Belgium")

# Check Normality of Distribution with Box Plot

b1 <- boxplot(a_data$fatality_rate, col="red")
b2 <- boxplot(b_data$fatality_rate, col="blue")

# Run t-test
t.test(a_data$fatality_rate,b_data$fatality_rate, conf.level = 0.95, alternative ="two.sided", var.equal = FALSE)

# Conclusion
# Given the Confidence Level of 0.95, there is an alpha of 0.05. Due to the alternative hypothesis being != instead of <= or >=, this will be a two-sided t-test. The resulted p-value is 0.0007716, which is almost zero. Conclusively, we can reject the null hypothesis that the avg fatality rate in Austria is equal to that of Belgium. 
```

#### (3) Correlation Testing
  
```{r correlation, fig.width = 8, fig.height = 8}
## Correlation

# Visualizations for incidence and fatality rates in all countries 

p5 <- ggplot(data=data,aes(x=incidence_rate,y=fatality_rate)) +
  ggtitle("COVID-19 Incidence Rates per 100,000") +
  geom_point() +
  theme(plot.title = element_text(hjust = .5)) +
  xlab("Incidence Rate") + 
  xlim(0, 1000) +
  ylab("Fatality Rate") +
  ylim(0, 20) +
  scale_fill_brewer(palette='Spectral')

cor.test(x = data$incidence_rate, y = data$fatality_rate)

# Conclusions
# Given the correlation coefficient of 0.1126425, we can conclude that there is not a strong correlation between incident rates and fatality rates. This is likely the case due to the strong difference in each rates, where incidence rates are in high volume, but the fatality rates are not even comparable by value. Therefore, this is a suitable conclusion. 

```

#### (4) Regression Analysis

```{r regression_a, fig.width = 8, fig.height = 8}

# Code below creates a new data frame with only 20 countries

twenty_countries <- c("Austria", "Belgium", "Bulgaria", "Cyprus", "Denmark",
                      "Finland", "France", "Germany", "Hungary", "Ireland",
                      "Latvia", "Lithuania", "Malta", "Norway", "Poland",
                      "Portugal", "Romania", "Slovakia", "Spain", "Sweden")

sq_km <- c(83858, 30510, 110994, 9251, 44493, 338145, 551695, 357386, 93030,
           70273, 64589, 65300, 316, 385178, 312685, 88416, 238397, 49036,
           498511, 450295)

gdp_pps <- c(128, 118, 51, 91, 129, 111, 104, 123, 71, 190, 69, 81, 100, 142,
             71, 78, 65, 71, 91, 120)

model_df <- data %>%
  select(c(countriesAndTerritories, popData2020)) %>%
  filter(countriesAndTerritories %in% twenty_countries) %>%
  distinct(countriesAndTerritories, .keep_all = TRUE) %>%
  add_column(sq_km, gdp_pps) %>%
  mutate(pop_dens = popData2020 / sq_km) %>%
  rename(country = countriesAndTerritories, pop = popData2020)

```


```{r regression_b}
total_cases <- data %>%
  select(c(countriesAndTerritories, cases)) %>%
  group_by(countriesAndTerritories) %>%
  dplyr::summarize(total_cases = sum(cases, na.rm = TRUE)) %>%
  filter(countriesAndTerritories %in% twenty_countries) %>%
  select(total_cases)

model_df <- model_df %>%
  add_column(total_cases)
```


```{r regression_c}
# fit model using data in 'model_df'

regression1 <- lm(total_cases~pop+pop_dens+gdp_pps, data = model_df)

summary(regression1)

# Conclusions
# Based on the lm function, I found that the model is statistically significant overall. However, when examining the individual coefficients, only the 'population' variable emerged as statistically significant, where this had a very low p-value of 2.71e-09 (or almost zero). This result makes logical sense, as a higher population would naturally be associated with a greater number of total cases. The Adjusted R-squared value is 0.8963, indicating that the model explains a high proportion of the variance in total cases and is an overall good fit for a future analysis. 

# However, to further improve this model, I would like to investigate the statistical significance of total_cases across different combinations of selected variables to identify the most meaningful predictors for accurate conclusions. This could involve testing interaction effects or running alternative regression models to determine which variable sets yield both high model fit and statistically significant results.

```

The last thing we will do is use our model to predict the  total new cases of two (2) countries not included in our model fit. At minimum, your work should include:

* The predicted total new cases for both countries.
* The actual total new cases for both countries.
* A short statement on the performance of the model in these two (2) cases.
    + Compare the new predictions to those made on the fitted dataset. You may compare the predicted values or the residuals.
  
```{r regression_d}

# predict the  total new cases of two (2) countries not included in our model fit

newdata <- data.frame(country = c("Luxembourg", "Netherlands"),
                      pop = c(626108, 17407585),
                      gdp_pps = c(261, 130),
                      pop_dens = c(626108, 17407585) / c(2586, 41540))

# Add code here returning the actual  total cases from our dataset for the
# Netherlands and Luxembourg.
act_total_cases <- data %>%
  select(c(countriesAndTerritories, cases)) %>%
  group_by(countriesAndTerritories) %>%
  dplyr::summarize(total_cases = sum(cases, na.rm = TRUE)) %>%
  filter(countriesAndTerritories %in% c("Luxembourg", "Netherlands")) %>%
  select(total_cases)

newdata <- newdata %>%
  add_column(act_total_cases)

# Add code here returning the total cases for the Netherlands and Luxembourg
# predicted by our model.

yint1 = -3.859e+06
cf1 = 4.268e-01
cf2 = 6.499e+02
cf3 = 2.831e+04


total_cases_model <- yint1 + (cf1*newdata$pop) + (cf2*newdata$pop_dens) + (cf3*newdata$gdp_pps)


cat("Projected Luxembourg Total Cases: ", format(total_cases_model[newdata$country == "Luxembourg"],big.mark=",", scientific=FALSE), "
", "Projected Netherlands Total Cases: ", format(total_cases_model[newdata$country == "Netherlands"],big.mark=",", scientific=FALSE))

# Comparison Conclusion:
diff1 = ((total_cases_model[newdata$country == "Luxembourg"])/(newdata$total_cases[newdata$country == "Luxembourg"]))
diff2 = ((total_cases_model[newdata$country == "Netherlands"])/(newdata$total_cases[newdata$country == "Netherlands"]))

cat(
  "Projected Luxembourg Total Cases: ", 
  format(total_cases_model[newdata$country == "Luxembourg"],big.mark=",", scientific=FALSE),"
    ",
  "Projected Netherlands Total Cases: ", 
  format(total_cases_model[newdata$country == "Netherlands"],big.mark=",", scientific=FALSE),"
    ",
  "Actual Luxembourg Total Cases: ", 
  format(newdata$total_cases[newdata$country == "Luxembourg"],big.mark=",", scientific=FALSE),"
    ",
  "Actual Netherlands Total Cases: ", 
  format(newdata$total_cases[newdata$country == "Netherlands"],big.mark=",", scientific=FALSE),"
  ",
  "Luxembourg % Difference: ",
  round(diff1, digits = 2),
  "%","
  ",
  "Netherlands % Difference: ",
  round(diff2, digits = 2),
  "%", "
  ",
  "From this analysis, we can see that the model for the Netherlands is more accurate than the Luxembourg model, where the difference is higher in Luxembourg than the Netherlands."
  )

# Additional Research
# As suggested above, it is likely that GDP may be throwing off the models here, so for additional research, this factor will be removed:

regression2 <- lm(total_cases~pop+pop_dens, data = model_df)

summary(regression2)

yint2 = -1.052e+06
cf4 = 4.279e-01
cf5 = 7.107e+02

total_cases_model2 <- yint2 + (cf4*newdata$pop) + (cf5*newdata$pop_dens)

diff3 = ((total_cases_model2[newdata$country == "Luxembourg"])/(newdata$total_cases[newdata$country == "Luxembourg"]))
diff4 = ((total_cases_model2[newdata$country == "Netherlands"])/(newdata$total_cases[newdata$country == "Netherlands"]))

cat(
  "New Model: Luxembourg % Difference: ",
  round(diff3, digits = 2),
  "%","
  ",
  "New Model:Netherlands % Difference: ",
  round(diff4, digits = 2),
  "%", "
  ",
  "From this analysis, we can see that the model for the Netherlands and the Luxembourg model,are more accurate when removing the GDP variable, where this variable may not be an accurate predictor for total_cases.")

```
